---
title: "Predicting salaries of WNBA players"
author: Caban
date: '`r Sys.Date()`'
output:
  html_document:
    code_folding: hide
    number_sections: yes
    theme: lumen
    toc: yes
    toc_depth: 3
    toc_float: yes
urlcolor: blue
---


```{r setup, include=FALSE}

# Set knitr options
knitr::opts_chunk$set(
  echo = T, 
  fig.width=8, 
  # fig.height=4, 
  warning = F, 
  dpi = 300,
  message = F,
  comment = NA
  )





if(!require('pacman')) {install.packages('pacman')}

# Load all libraries
pacman::p_load(readxl, rstatix, bestglm, glmnet, leaps, car, tidyverse, pROC, caret, tree, rpart, randomForest, rpart.plot)


```






```{r}

# create functions and general ggplot vectors to streamline code and make it more reproducible




# Function to control the table output
kable2 <- function(x) {
  knitr::kable(x) 
     }


# Plot color palette 
colors <- c(
  "#6C946F",
  "#FFD35A",
  "#FFA823",
  "#DC0083"
)


# Histogram
plot_hist <- list(
  geom_histogram(aes(y= after_stat(density)), fill=colors[1], color=colors[4]),
  geom_density(color=colors[2], linewidth=1),
  theme_light(),
  theme(plot.title = element_text(hjust = 0.5))
)


# Line plot
plot_line2 <- list(
  geom_line(color = colors[1]),
  scale_color_manual(values = c(colors[1], colors[2])),
  guides(color = "none"),
  theme_light(),
  theme(
    plot.title = element_text(hjust = 0.5)
    )
)


```



# Methodology


## Datasets

The WNBA players' stats were scraped form:
https://www.basketball-reference.com/


Salaries
https://www.spotrac.com/wnba/rankings/

CPI:
https://stats.oecd.org




## Variables


Variables imported as part of the players' stats

| Abbreviation | Description                            |
|--------------|----------------------------------------|
| Pos          | Position                               |
| G            | Games                                  |
| MP           | Minutes Played                         |
| GS           | Games Started                          |
| FG           | Field Goals                            |
| FGA          | Field Goal Attempts                    |
| FG%          | Field Goal Percentage                  |
| 3P           | 3-Point Field Goals                    |
| 3PA          | 3-Point Field Goal Attempts            |
| 3P%          | 3-Point Field Goal Percentage          |
| 2P           | 2-Point Field Goals                    |
| 2PA          | 2-point Field Goal Attempts            |
| 2P%          | 2-Point Field Goal Percentage          |
| FT           | Free Throws                            |
| FTA          | Free Throw Attempts                    |
| FT%          | Free Throw Percentage                  |
| ORB          | Offensive Rebounds                     |
| TRB          | Total Rebounds                         |
| AST          | Assists                                |
| STL          | Steals                                 |
| BLK          | Blocks                                 |
| TOV          | Turnovers                              |
| PF           | Personal Fouls                         |
| PTS          | Points                                 |



# Data Import and Cleaning


## Salaries

```{r}
# Import salary dataset
salaries <- read_csv("WNBA - salaries.csv")

salaries %>% 
  glimpse()
```



```{r}

salaries %>% 
  is.na() %>% 
  colSums()

```



```{r}
duplicates <- salaries %>% 
  duplicated() %>% 
  sum()




```

There were `r duplicates` duplicates in the salary dataset.

```{r}
salaries[duplicated(salaries),]
```

The only duplicate concers Sylvia Fowles.
According to spotrac (url: https://www.spotrac.com/wnba/player/_/id/29907/sylvia-fowles#:~:text=Sylvia%20Fowles%20signed%20a%203%20year%20%2C%20%24333%2C540%20contract%20with%20the,average%20annual%20salary%20of%20%24111%2C180.) she extended her contract averaging 115k dollars a year. 
As such this duplicate seems to be a random error and is safe to be removed.


```{r}
# Remove duplicates
salaries <- salaries %>%
  rename(year = Year) %>%
  unique()
```


## WNBA stats


```{r}
# List player stats datasets for all years
stats_files <- list.files("players stats")

# Vector for import
stats_import <- str_c("players stats/", stats_files)

# Import all files
stats_imported <- stats_import %>% 
  map(read_excel)

# Check compatibility
stats_imported %>% 
  map(names) %>% 
  reduce(setdiff)
```

There are no differences in names of the datasets when compared one after another


```{r}

stats_imported %>% 
  map_dbl(length) %>% 
  unique()
```

All datasets have the same number of variables


```{r}
# Combine all WNBA stats datasets into one
wnba_stats <- stats_imported %>% 
  reduce(add_row)

```


```{r}

glimpse(wnba_stats)

```


```{r}
wnba_stats %>% 
  duplicated() %>% 
  sum()

```


```{r}

wnba_stats %>% 
  select(where(is.character)) %>% 
  select(-Player) %>% 
  map(unique)


```


### Correcting vector type

```{r}

wnba_stats <- wnba_stats %>% 
  mutate(
    across(ends_with("%"), ~as.double(.))
  )

```


### Summary stats

```{r}

wnba_stats %>% 
  get_summary_stats()

```


### Correcting duplicate variables


```{r}
duplicated_vars <- wnba_stats %>% 
  as.list.data.frame() %>% 
  duplicated() 


wnba_stats[, duplicated_vars]




  

```

Two variables are duplicated. 


```{r}


# Remove duplicates
wnba_stats <- wnba_stats[, !duplicated_vars]


```



### Missing data


```{r}

wnba_missing <- wnba_stats %>% 
  is.na() %>% 
  colSums() %>% 
  sort(decreasing = T) %>% 
  keep(~. != 0)

wnba_missing %>% 
  enframe(name = "variable", value = "missing_sum")
  

```

Missing data were observed only for the variables measuring percentage of successes in a given performance category.

Let's inspect observations in terms of the absolute success and overall attempts separately
for each category only for the missing data.


```{r}
## Inspect all missing observations ##

# create vector for filtering over missing data
missing_filter <- wnba_missing %>% 
  names() %>% 
  str_replace("%", "") 


# Empty list
wnba_NAs <- list()

# Obtain separate datasets with missing variables for each set of variables
for (i in seq_along(missing_filter)) {
  
  wnba_NAs[[i]] <- wnba_stats %>% 
    select(starts_with(missing_filter[i])) %>% 
    filter(if_any(everything(), ~is.na(.))) %>% 
    select(sort(names(.))) %>% 
    set_names(c("Absolute successes", "Pct successes", "Total attemps")) %>% 
    mutate(category = missing_filter[[i]])
  
}


wnba_NAs %>% 
  map(unique) %>% 
  reduce(add_row) %>% 
  select(category, everything())
```

As we can see, missing data for percentage of success occurred only in situations when there were zero total attempts. 
This makes sense, because you can obtain a proportion out of nothing.


```{r}
missing_filter %>% 
  map(select, .data = wnba_stats)

wnba_chunks <- missing_filter %>% 
  map(~select(wnba_stats, starts_with(.))) %>% 
  map(drop_na)


wnba_chunks %>% 
  map(cor_test)
```


```{r}
wnba_chunks %>% 
  map(plot)


```

There are strong linear associations between successes and attempts for each category of player's performance, above 0.9 high.
In case of linear models, it would be necessary to remove either of the two for each pair, in order to avoid collinearity. 

Interestingly, the relationship between the percentage of successful attempts and the absolute values of the sucessess and attempts is not linear. The majority of observations had between 30% and 60% of successful attempts, showing also a relatively large dispersion of absolute attempts and successes.
Players below or above this range were noticeably similar to one another in terms of absolute attempts and successes which were overall closer to zero.
This implies that having just a few attempts makes the player's percentage of successes a less objective performance measure, as one or two shots can decide whether a player has 0 or 100% success rate. 


```{r}

wnba_chunks %>% 
  map(
    ~filter(., .[[names(.)[[2]]]] <= 2)
    ) %>% 
  map(
    ~count(., .[[names(.)[[3]]]])
  )

```


```{r}
wnba_chunks %>% 
  map(
    ~filter(., .[[names(.)[[2]]]] > 50)
    ) %>% 
  map(plot)
```


```{r}
wnba_chunks %>% 
  map(
    ~filter(., .[[names(.)[[2]]]] > 50)
    ) %>% 
  map(cor_test)

```






